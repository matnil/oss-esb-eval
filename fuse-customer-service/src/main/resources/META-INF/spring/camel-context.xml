<?xml version="1.0" encoding="UTF-8"?>
<!-- Generated by Apache ServiceMix Archetype -->
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:osgi="http://www.springframework.org/schema/osgi"
       xmlns:osgix="http://www.springframework.org/schema/osgi-compendium"
       xmlns:ctx="http://www.springframework.org/schema/context"
       xmlns:cxf="http://camel.apache.org/schema/cxf"
	   
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
       http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd
       http://camel.apache.org/schema/osgi http://camel.apache.org/schema/osgi/camel-osgi.xsd
       http://www.springframework.org/schema/osgi http://www.springframework.org/schema/osgi/spring-osgi.xsd
       http://www.springframework.org/schema/osgi-compendium http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
       http://camel.apache.org/schema/cxf http://camel.apache.org/schema/cxf/camel-cxf.xsd
       http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd">

	<!--  config uses atomikos to do auto registration of jms connections and database connections with the xa transaction manager -->

    <bean id="activemq" class="org.apache.activemq.camel.component.ActiveMQComponent">
        <property name="transactionManager" ref="jtaTransactionManager"/>
        <property name="cacheLevelName" value="CACHE_NONE"/>
        <property name="transacted" value="true"/>
        <property name="connectionFactory" ref="atomikosXaConnectionFactoryBean"/>
    </bean>

     <bean id="atomikosTransactionManager" class="com.atomikos.icatch.jta.UserTransactionManager" init-method="init" destroy-method="close" >
        <property name="forceShutdown" value="false" />
    </bean>

    <bean id="atomikosUserTransaction" class="com.atomikos.icatch.jta.UserTransactionImp" >
        <property name="transactionTimeout" value="60" />
    </bean>
 
     <bean id="jtaTransactionManager" class="org.springframework.transaction.jta.JtaTransactionManager">
        <property name="transactionManager" ref="atomikosTransactionManager" />
        <property name="userTransaction" ref="atomikosUserTransaction" />
        <property name="allowCustomIsolationLevels" value="true" />
    </bean>
    
    <bean id="transactionTemplate"  class="org.springframework.transaction.support.TransactionTemplate">
        <property name="transactionManager" ref="jtaTransactionManager" />
        <property name="isolationLevelName" value="ISOLATION_REPEATABLE_READ"/>
        <property name="timeout" value="60"/>
    </bean>
    
    <bean id="jmsXaConnectionFactory" class="org.apache.activemq.ActiveMQXAConnectionFactory">
        <property name="brokerURL" value="tcp://localhost:61616" />
        <property name="redeliveryPolicy">
            <bean class="org.apache.activemq.RedeliveryPolicy">
                <property name="maximumRedeliveries" value="1"/>
            </bean>
        </property>
    </bean>
    
    <bean id="atomikosXaConnectionFactoryBean" class="com.atomikos.jms.AtomikosConnectionFactoryBean" init-method="init" destroy-method="close">
        <property name="uniqueResourceName" value="amq1" />
        <property name="xaConnectionFactory" ref="jmsXaConnectionFactory" />
        <property name="localTransactionMode" value ="false" />
        <property name="minPoolSize" value="2"/>
        <property name="maxPoolSize" value="10" />
        <property name="reapTimeout" value="0" />
    </bean>
    
	<bean id="PROPAGATION_REQUIRES_NEW" class="org.apache.camel.spring.spi.SpringTransactionPolicy">
	  <property name="transactionManager" ref="jtaTransactionManager"/>
      <property name="transactionTemplate" ref="transactionTemplate" />	  
	  <property name="propagationBehaviorName" value="PROPAGATION_REQUIRES_NEW"/>
	</bean>

    <bean id="atomikosXaDataSourceBean" class="com.atomikos.jdbc.AtomikosDataSourceBean">
        <property name="uniqueResourceName" value="ds1" />
        <property name="testQuery" value="select 1" />
        <property name="xaDataSource" ref="pgXADataSource" />
        <property name="minPoolSize" value="2"/>
        <property name="maxPoolSize" value="10"/>
        <property name="reapTimeout" value="0" />
    </bean>
    
	<bean id="pgXADataSource" class="org.postgresql.xa.PGXADataSource">
        <property name="databaseName" value="ipleval" />
        <property name="user" value="ipleval" />
        <property name="password" value="ipleval" />
    </bean>     

  <camelContext xmlns="http://camel.apache.org/schema/spring">
      <package>example.customer_service</package>
  </camelContext>
  
</beans>
